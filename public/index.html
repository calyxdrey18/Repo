<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CALYX-DREY :: Secure Comms</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --matrix-green: #0aff0a;
      --neon-purple: #bc13fe;
      --hacker-red: #ff0038;
      --darkest: #000000;
      --darker: #0a0a0a;
      --dark: #111111;
      --glow: 0 0 10px var(--matrix-green);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--darkest);
      color: var(--matrix-green);
      font-family: 'Courier New', monospace;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background-color: var(--darker);
      border: 1px solid var(--matrix-green);
      padding: 30px;
      box-shadow: var(--glow);
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 10px;
      text-shadow: var(--glow);
    }

    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      color: var(--neon-purple);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: bold;
      color: var(--matrix-green);
    }

    input[type="text"],
    input[type="url"] {
      padding: 12px;
      background: var(--dark);
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      font-family: 'Courier New', monospace;
    }

    .file-upload {
      border: 2px dashed var(--matrix-green);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin: 15px 0;
    }

    .file-upload:hover {
      background: rgba(10, 255, 10, 0.1);
    }

    button {
      padding: 15px;
      background: var(--dark);
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      font-family: 'Courier New', monospace;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      background: var(--matrix-green);
      color: var(--darkest);
      box-shadow: var(--glow);
    }

    #formMsg {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
    }

    .success {
      color: var(--matrix-green);
      border: 1px solid var(--matrix-green);
    }

    .error {
      color: var(--hacker-red);
      border: 1px solid var(--hacker-red);
    }

    .search-container {
      margin: 30px 0;
      position: relative;
    }

    .search-container input {
      width: 100%;
      padding: 12px 40px 12px 15px;
    }

    .search-container i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
    }

    .group-card {
      background: var(--dark);
      border: 1px solid var(--matrix-green);
      padding: 20px;
      margin-bottom: 20px;
    }

    .group-name {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .group-user {
      color: var(--neon-purple);
      margin-bottom: 15px;
      font-style: italic;
    }

    .group-link {
      display: block;
      padding: 10px;
      background: var(--darker);
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      text-align: center;
      text-decoration: none;
      font-weight: bold;
    }

    .group-link:hover {
      background: var(--matrix-green);
      color: var(--darkest);
    }

    #previewImg {
      max-width: 100px;
      max-height: 100px;
      margin: 10px auto;
      display: block;
      border: 1px solid var(--matrix-green);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tech WhatsApp Groups</h1>
    <p class="subtitle">Connect, share, and grow with tech communities</p>

    <form id="groupForm">
      <div class="form-group">
        <label>Your Username</label>
        <input type="text" id="username" placeholder="Your name or handle" required>
      </div>

      <div class="form-group">
        <label>Group Name</label>
        <input type="text" id="groupName" placeholder="Tech Talk" required>
      </div>

      <div class="form-group">
        <label>WhatsApp Group Link</label>
        <input type="url" id="groupLink" placeholder="https://chat.whatsapp.com/..." required>
      </div>

      <div class="file-upload">
        <label>Click or drag & drop to upload a photo (optional)</label>
        <input type="file" id="groupImage" accept="image/*" style="display: none;">
        <img id="previewImg" style="display: none;">
      </div>

      <button type="submit">Submit</button>
      <div id="formMsg"></div>
    </form>

    <div class="search-container">
      <input type="search" id="searchInput" placeholder="Search groups...">
      <i class="fas fa-search"></i>
    </div>

    <div id="groupList">
      <!-- Groups will be loaded here -->
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('groupForm');
      const searchInput = document.getElementById('searchInput');
      const groupList = document.getElementById('groupList');
      const formMsg = document.getElementById('formMsg');
      const groupImageInput = document.getElementById('groupImage');
      const previewImg = document.getElementById('previewImg');
      const fileUpload = document.querySelector('.file-upload');

      // File upload handling
      fileUpload.addEventListener('click', () => {
        groupImageInput.click();
      });

      groupImageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          const reader = new FileReader();
          
          reader.onload = (event) => {
            previewImg.src = event.target.result;
            previewImg.style.display = 'block';
          };
          
          reader.readAsDataURL(file);
        }
      });

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const groupName = document.getElementById('groupName').value.trim();
        const groupLink = document.getElementById('groupLink').value.trim();
        const imagePath = previewImg.src || '';

        if (!username || !groupName || !groupLink) {
          showMessage('All fields are required', 'error');
          return;
        }

        try {
          const response = await fetch('/api/groups', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username,
              groupName,
              groupLink,
              imagePath
            })
          });

          const result = await response.json();

          if (response.ok) {
            showMessage('Group added successfully!', 'success');
            form.reset();
            previewImg.style.display = 'none';
            groupImageInput.value = '';
            loadGroups();
          } else {
            showMessage(result.error || 'Failed to add group', 'error');
          }
        } catch (error) {
          showMessage('Network error. Please try again.', 'error');
        }
      });

      // Search functionality
      searchInput.addEventListener('input', () => {
        loadGroups(searchInput.value.trim());
      });

      // Load groups
      async function loadGroups(search = '') {
        groupList.innerHTML = 'Loading...';
        
        try {
          const response = await fetch(`/api/groups${search ? '?q=' + encodeURIComponent(search) : ''}`);
          const groups = await response.json();

          if (groups.length === 0) {
            groupList.innerHTML = 'No groups found';
            return;
          }

          groupList.innerHTML = '';
          groups.forEach(group => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.innerHTML = `
              <div class="group-name">${escapeHtml(group.groupName)}</div>
              <div class="group-user">Shared by: ${escapeHtml(group.username)}</div>
              <a href="${escapeHtml(group.groupLink)}" class="group-link" target="_blank">Join Group</a>
            `;
            groupList.appendChild(card);
          });
        } catch (error) {
          groupList.innerHTML = 'Failed to load groups';
        }
      }

      // Helper functions
      function escapeHtml(text) {
        return text.replace(/[&<>"']/g, function(m) {
          return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
          }[m];
        });
      }

      function showMessage(msg, type) {
        formMsg.textContent = msg;
        formMsg.className = type;
      }

      // Initial load
      loadGroups();
    });
  </script>
</body>
</html>
